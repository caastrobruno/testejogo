<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let groundY = 0;
function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
  groundY = canvas.height - 90;
}
resize();
addEventListener("resize", resize);

/* CONSTANTS */
const GRAVITY = 0.9;
const SPEED = 5;
const JUMP = -18;
const LONG_JUMP = -26;
const LONG_JUMP_PUSH = 5;

/* PLAYER */
const player = {
  x: 100,
  y: 0,
  w: 32,
  h: 48,
  vx: 0,
  vy: 0,
  onGround: false,
  dir: 1
};

/* CONTROLES */
let left=false, right=false;

/* DOUBLE TAP */
let lastJumpTap = 0;
const DOUBLE_TAP_TIME = 300;

/* MOVIMENTO (sem pulo aqui!) */
function readTouches(touches){
  left = right = false;
  const third = innerWidth / 3;

  for(const t of touches){
    if(t.clientX < third) left = true;
    else if(t.clientX > third*2) right = true;
  }
}

/* TOUCH EVENTS */
canvas.addEventListener("touchstart",e=>{
  e.preventDefault();

  const t = e.changedTouches[0];
  const third = innerWidth / 3;

  // ÃREA DO PULO (CENTRO)
  if(t.clientX >= third && t.clientX <= third*2 && player.onGround){
    const now = Date.now();

    if(now - lastJumpTap < DOUBLE_TAP_TIME){
      // SALTO LONGO
      player.vy = LONG_JUMP;
      player.vx += player.dir * LONG_JUMP_PUSH;
    } else {
      // PULO NORMAL
      player.vy = JUMP;
    }

    player.onGround = false;
    lastJumpTap = now;
  }

  readTouches(e.touches);
});

canvas.addEventListener("touchmove",e=>{
  e.preventDefault();
  readTouches(e.touches);
});

canvas.addEventListener("touchend",e=>{
  e.preventDefault();
  readTouches(e.touches);
});

/* WORLD */
const pipes = [
  {x: 500, w: 44, h: 110},
  {x: 900, w: 44, h: 160}
];

const castle = { x: 1300, w: 220, h: 200 };

let camX = 0;

/* UPDATE */
function update(){
  if(left){
    player.vx = -SPEED;
    player.dir = -1;
  } else if(right){
    player.vx = SPEED;
    player.dir = 1;
  } else {
    player.vx = 0;
  }

  player.vy += GRAVITY;
  player.x += player.vx;
  player.y += player.vy;

  if(player.y + player.h >= groundY){
    player.y = groundY - player.h;
    player.vy = 0;
    player.onGround = true;
  }

  pipes.forEach(p=>{
    const pipeTop = groundY - p.h;
    const overlapX =
      player.x < p.x + p.w &&
      player.x + player.w > p.x;

    if(
      overlapX &&
      player.vy >= 0 &&
      player.y + player.h >= pipeTop &&
      player.y + player.h - player.vy < pipeTop
    ){
      player.y = pipeTop - player.h;
      player.vy = 0;
      player.onGround = true;
    }
    else if(overlapX && player.y + player.h > pipeTop){
      if(player.vx > 0) player.x = p.x - player.w;
      if(player.vx < 0) player.x = p.x + p.w;
    }
  });

  if(player.x + player.w > castle.x + 60){
    document.getElementById("proposal").style.display="flex";
  }

  camX = player.x - 150;
}

/* DRAW */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle="#7c4a16";
  ctx.fillRect(-camX, groundY, 4000, 90);

  pipes.forEach(p=>{
    const x = p.x - camX;
    const y = groundY - p.h;

    ctx.fillStyle="#2ecc71";
    ctx.fillRect(x, y+14, p.w, p.h-14);
    ctx.fillStyle="#27ae60";
    ctx.fillRect(x + p.w - 6, y+14, 6, p.h-14);
    ctx.fillStyle="#2ecc71";
    ctx.fillRect(x - 6, y, p.w + 12, 16);
    ctx.fillStyle="#1e8449";
    ctx.fillRect(x - 6, y+12, p.w + 12, 4);
  });

  const cx = castle.x - camX;
  const cy = groundY - castle.h;

  ctx.fillStyle="#b0b0b0";
  ctx.fillRect(cx, cy, castle.w, castle.h);

  ctx.fillStyle="#9a9a9a";
  for(let y=cy+20;y<cy+castle.h;y+=20){
    for(let x=cx;x<cx+castle.w;x+=40){
      ctx.fillRect(x+2,y+2,36,16);
    }
  }

  ctx.fillStyle="#8e8e8e";
  ctx.fillRect(cx-30, cy+40, 30, castle.h-40);
  ctx.fillRect(cx+castle.w, cy+40, 30, castle.h-40);

  ctx.fillStyle="#777";
  for(let i=0;i<castle.w;i+=30){
    ctx.fillRect(cx+i, cy-12, 18, 12);
  }

  ctx.fillStyle="#333";
  ctx.fillRect(cx+castle.w/2-20, groundY-60, 40, 60);

  ctx.fillStyle="#000";
  ctx.fillRect(cx+castle.w/2, cy-50, 4, 50);
  ctx.fillStyle="red";
  ctx.fillRect(cx+castle.w/2+4, cy-50, 22, 14);

  const x=player.x-camX,y=player.y;
  ctx.fillStyle="#ff0000";
  ctx.fillRect(x+6,y,20,8);
  ctx.fillStyle="#f1c27d";
  ctx.fillRect(x+8,y+8,16,12);
  ctx.fillStyle="#ff0000";
  ctx.fillRect(x+4,y+20,24,12);
  ctx.fillStyle="#0066ff";
  ctx.fillRect(x+4,y+32,24,12);
}

/* LOOP */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

function yes(){
  document.getElementById("final").innerText =
    "ðŸŽ‰ Player 2 desbloqueado para a vida toda ðŸŽ‰";
}
function no(){
  document.getElementById("final").innerText =
    "âŒ Essa fase nÃ£o aceita essa escolha ðŸ˜";
}
</script>
