<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Super Mario World</title>
<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#5c94fc;
}
canvas{display:block;}
#hud{
  position:fixed;
  top:10px;
  left:10px;
  font-family:Arial;
  font-size:20px;
  color:white;
  text-shadow:2px 2px #000;
}
</style>
</head>
<body>

<div id="hud">FASE 1 | ðŸª™ 0</div>
<canvas id="game"></canvas>

<script>
/* ================= BASE ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const hud = document.getElementById("hud");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

/* ================= CONSTANTES ================= */
const GRAVITY = 0.8;
const SPEED = 5;
const JUMP = -16;
const LONG_JUMP = -24;
const DOUBLE_TAP_TIME = 250;

/* ================= PLAYER ================= */
const player = {
  x:100,y:0,w:30,h:45,
  vx:0,vy:0,
  onGround:false,
  lastJumpTime:0,
  longUsed:false,
  dir:1
};

const groundY = () => canvas.height - 80;

/* =====================================================
   CONTROLES â€” NÃƒO MEXER
===================================================== */
let leftFinger = null;
let rightFinger = null;
let jumpFinger = null;

canvas.addEventListener("touchstart", e=>{
  e.preventDefault();
  for(const t of e.changedTouches){
    const third = canvas.width / 3;
    const now = Date.now();

    if(t.clientX < third && leftFinger === null){
      leftFinger = t.identifier;
      player.dir = -1;
    }
    else if(t.clientX > third*2 && rightFinger === null){
      rightFinger = t.identifier;
      player.dir = 1;
    }
    else if(t.clientX >= third && t.clientX <= third*2 && jumpFinger === null){
      jumpFinger = t.identifier;

      if(player.onGround){
        player.vy = JUMP;
        player.onGround = false;
        player.lastJumpTime = now;
        player.longUsed = false;
      }
      else if(!player.longUsed && now - player.lastJumpTime < DOUBLE_TAP_TIME){
        player.vy = LONG_JUMP;
        player.longUsed = true;
      }
    }
  }
});

canvas.addEventListener("touchend", e=>{
  e.preventDefault();
  for(const t of e.changedTouches){
    if(t.identifier === leftFinger) leftFinger = null;
    if(t.identifier === rightFinger) rightFinger = null;
    if(t.identifier === jumpFinger) jumpFinger = null;
  }
});

/* ================= FASES ================= */
let fase = 1;
let camX = 0;
let coinCount = 0;

let pipes = [];
let turtles = [];
let plants = [];
let coins = [];
let faseEndX = 1500;

function loadFase(n){
  player.x = 100;
  camX = 0;

  if(n === 1){
    pipes = [
      {x:400,w:44,h:120},
      {x:700,w:44,h:160}
    ];
    turtles = [];
    plants = [];
    coins = [
      {x:300,y:groundY()-140,collected:false},
      {x:600,y:groundY()-180,collected:false}
    ];
    faseEndX = 1200;
  }

  if(n === 2){
    pipes = [
      {x:350,w:44,h:120},
      {x:650,w:44,h:160},
      {x:950,w:44,h:120}
    ];
    turtles = [
      {x:500,w:32,h:32,vx:-1.2},
      {x:820,w:32,h:32,vx:1.2}
    ];
    plants = pipes.map(p=>({pipe:p,offset:0,dir:-1}));
    coins = [
      {x:450,y:groundY()-200,collected:false}
    ];
    faseEndX = 1500;
  }

  if(n === 3){
    pipes = [
      {x:400,w:44,h:160},
      {x:800,w:44,h:160}
    ];
    turtles = [
      {x:600,w:32,h:32,vx:-1.5}
    ];
    plants = pipes.map(p=>({pipe:p,offset:0,dir:-1}));
    coins = [
      {x:500,y:groundY()-220,collected:false}
    ];
    faseEndX = 1400;
  }

  hud.innerHTML = `FASE ${fase} | ðŸª™ ${coinCount}`;
}

loadFase(fase);

/* ================= UPDATE ================= */
function update(){
  player.vx = 0;
  if(leftFinger!==null) player.vx=-SPEED;
  if(rightFinger!==null) player.vx=SPEED;

  player.vy += GRAVITY;
  player.x += player.vx;
  player.y += player.vy;

  if(player.y + player.h >= groundY()){
    player.y = groundY() - player.h;
    player.vy = 0;
    player.onGround = true;
    player.longUsed = false;
  }

  pipes.forEach(p=>{
    const top = groundY() - p.h;
    if(player.x < p.x+p.w && player.x+player.w > p.x){
      if(player.vy>=0 && player.y+player.h>=top &&
         player.y+player.h-player.vy<top){
        player.y = top - player.h;
        player.vy = 0;
        player.onGround = true;
      }
    }
  });

  turtles.forEach(t=>{
    t.x += t.vx;
    t.y = groundY() - t.h;
  });

  plants.forEach(pl=>{
    pl.offset += pl.dir * 0.5;
    if(pl.offset < -40 || pl.offset > 0) pl.dir *= -1;
  });

  coins.forEach(c=>{
    if(!c.collected &&
      player.x<c.x+20 &&
      player.x+player.w>c.x &&
      player.y<c.y+20 &&
      player.y+player.h>c.y){
      c.collected = true;
      coinCount++;
      hud.innerHTML = `FASE ${fase} | ðŸª™ ${coinCount}`;
    }
  });

  if(player.x > faseEndX){
    fase++;
    if(fase <= 3) loadFase(fase);
  }

  camX = player.x - 150;
}

/* ================= DRAW ================= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle="#7c4a16";
  ctx.fillRect(-camX,groundY(),4000,80);

  pipes.forEach(p=>{
    ctx.fillStyle="#2ecc71";
    ctx.fillRect(p.x-camX,groundY()-p.h,p.w,p.h);
  });

  turtles.forEach(t=>{
    ctx.fillStyle="#27ae60";
    ctx.fillRect(t.x-camX,t.y,t.w,t.h);
  });

  plants.forEach(pl=>{
    ctx.fillStyle="red";
    ctx.fillRect(pl.pipe.x-camX+6,
      groundY()-pl.pipe.h+pl.offset-30,
      pl.pipe.w-12,30);
  });

  coins.forEach(c=>{
    if(!c.collected){
      ctx.fillStyle="gold";
      ctx.beginPath();
      ctx.arc(c.x-camX+10,c.y+10,10,0,Math.PI*2);
      ctx.fill();
    }
  });

  ctx.fillStyle="red";
  ctx.fillRect(player.x-camX,player.y,player.w,player.h);
}

/* ================= LOOP ================= */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
