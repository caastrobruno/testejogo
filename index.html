<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Jogo Plataforma</title>
<style>
  html,body{
    margin:0;
    padding:0;
    overflow:hidden;
    background:#4da6ff;
  }
  canvas{
    display:block;
  }
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
/* CANVAS */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

/* CONSTANTES */
const GRAVITY = 0.9;
const SPEED = 5;
const JUMP = -18;
const LONG_JUMP = -26;
const LONG_JUMP_PUSH = 5;
const DOUBLE_TAP_TIME = 280;

/* CHÃO */
const groundHeight = 90;

/* PLAYER */
const player = {
  x: 100,
  y: 0,
  w: 32,
  h: 48,
  vx: 0,
  vy: 0,
  onGround: false,
  dir: 1,
  jumpTaps: 0,
  jumpTimer: null
};

/* CONTROLES */
let left = false;
let right = false;

/* TOUCH MOVIMENTO */
function readTouches(touches){
  left = right = false;
  const third = innerWidth / 3;

  for(const t of touches){
    if(t.clientX < third) left = true;
    else if(t.clientX > third*2) right = true;
  }
}

/* TOUCH START */
canvas.addEventListener("touchstart", e=>{
  e.preventDefault();
  const t = e.changedTouches[0];
  const third = innerWidth / 3;

  // ÁREA CENTRAL = PULO
  if(t.clientX >= third && t.clientX <= third*2){
    player.jumpTaps++;

    if(player.jumpTaps === 1){
      // pulo IMEDIATO
      player.vy = JUMP;
      player.onGround = false;

      player.jumpTimer = setTimeout(()=>{
        player.jumpTaps = 0;
      }, DOUBLE_TAP_TIME);
    }

    if(player.jumpTaps === 2){
      clearTimeout(player.jumpTimer);

      // SALTO LONGO
      player.vy = LONG_JUMP;
      player.vx += player.dir * LONG_JUMP_PUSH;
      player.jumpTaps = 0;
    }
  }

  readTouches(e.touches);
});

canvas.addEventListener("touchmove", e=>{
  e.preventDefault();
  readTouches(e.touches);
});

canvas.addEventListener("touchend", e=>{
  e.preventDefault();
  readTouches(e.touches);
});

/* MUNDO */
const pipes = [
  {x: 500, w: 44, h: 120},
  {x: 900, w: 44, h: 160},
  {x: 1250, w: 44, h: 100}
];

let camX = 0;

/* UPDATE */
function update(){
  // movimento horizontal
  if(left){
    player.vx = -SPEED;
    player.dir = -1;
  }else if(right){
    player.vx = SPEED;
    player.dir = 1;
  }else{
    player.vx = 0;
  }

  // física
  player.vy += GRAVITY;
  player.x += player.vx;
  player.y += player.vy;

  const groundY = canvas.height - groundHeight;

  // chão REAL
  if(player.y + player.h >= groundY){
    player.y = groundY - player.h;
    player.vy = 0;
    player.onGround = true;
    player.jumpTaps = 0;
  }else{
    player.onGround = false;
  }

  // colisão com canos
  pipes.forEach(p=>{
    const top = groundY - p.h;

    const overlapX =
      player.x < p.x + p.w &&
      player.x + player.w > p.x;

    // aterrissar EM CIMA do cano
    if(
      overlapX &&
      player.vy >= 0 &&
      player.y + player.h >= top &&
      player.y + player.h - player.vy < top
    ){
      player.y = top - player.h;
      player.vy = 0;
      player.onGround = true;
      player.jumpTaps = 0;
    }
    // colisão lateral (NÃO mexe no pulo)
    else if(
      overlapX &&
      player.y + player.h > top
    ){
      if(player.vx > 0) player.x = p.x - player.w;
      if(player.vx < 0) player.x = p.x + p.w;
    }
  });

  camX = player.x - 150;
}

/* DRAW */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const groundY = canvas.height - groundHeight;

  // chão
  ctx.fillStyle="#7c4a16";
  ctx.fillRect(-camX, groundY, 5000, groundHeight);

  // canos
  pipes.forEach(p=>{
    const x = p.x - camX;
    const y = groundY - p.h;

    ctx.fillStyle="#2ecc71";
    ctx.fillRect(x, y+14, p.w, p.h-14);
    ctx.fillStyle="#27ae60";
    ctx.fillRect(x + p.w - 6, y+14, 6, p.h-14);
    ctx.fillStyle="#2ecc71";
    ctx.fillRect(x - 6, y, p.w + 12, 16);
    ctx.fillStyle="#1e8449";
    ctx.fillRect(x - 6, y+12, p.w + 12, 4);
  });

  // player
  const px = player.x - camX;
  const py = player.y;

  ctx.fillStyle="#ff0000";
  ctx.fillRect(px+6, py, 20, 8);
  ctx.fillStyle="#f1c27d";
  ctx.fillRect(px+8, py+8, 16, 12);
  ctx.fillStyle="#ff0000";
  ctx.fillRect(px+4, py+20, 24, 12);
  ctx.fillStyle="#0066ff";
  ctx.fillRect(px+4, py+32, 24, 12);
}

/* LOOP */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
